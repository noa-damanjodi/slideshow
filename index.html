<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Event Slideshow</title>

<style>
  body {
    margin: 0;
    background: black;
    overflow: hidden;
    font-family: Arial, sans-serif;
  }

  #slideshow {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: black;
  }

  #slideshow img {
    width: 110vw;
    height: 110vh;
    object-fit: cover;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1.05);
    opacity: 0;
    transition: opacity 2s ease-in-out;
    transform-origin: center center;
  }

  /* Ken Burns zoom-in */
  @keyframes zoomInKB {
    from { transform: translate(-50%, -50%) scale(1.05); }
    to   { transform: translate(-50%, -50%) scale(1.18); }
  }

  /* Ken Burns zoom-out */
  @keyframes zoomOutKB {
    from { transform: translate(-50%, -50%) scale(1.18); }
    to   { transform: translate(-50%, -50%) scale(1.05); }
  }

  .kenburns-in {
    animation: zoomInKB 7s ease-in-out forwards;
  }

  .kenburns-out {
    animation: zoomOutKB 7s ease-in-out forwards;
  }

  /* Optional small loading text (will be hidden once images start) */
  #loadingText {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #ffffffcc;
    font-size: 20px;
    z-index: 10;
    font-family: Arial, sans-serif;
  }
</style>
</head>

<body>

<!-- Background Music (auto-start hack will be used in JS) -->
<audio id="bgmusic" loop preload="auto">
  <source src="https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/A_A_Aalto/Resting_Place/A_A_Aalto_-_Resting_Place.mp3" type="audio/mpeg">
</audio>

<div id="loadingText">Loading slideshow…</div>

<!-- Slideshow Container -->
<div id="slideshow"></div>

<script>
// GOOGLE DRIVE API URL (your working one)
const API_URL = "https://script.google.com/macros/s/AKfycbxVJbEXzRdQzTXiX4N9p4HQhySI1VGJcOXhdVjk6py_XFWuyZtA1KPmVWQvAnGhhXmm/exec";


// CONFIG
const SLIDE_DURATION = 7000; // 7 seconds

let photos = [];
let index = 0;
let imgs = [];
let slideshowStarted = false;

// Shuffle helper
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Auto fullscreen (where supported)
function requestFullscreenSafe() {
  const docEl = document.documentElement;
  try {
    if (docEl.requestFullscreen) docEl.requestFullscreen();
    else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen();
    else if (docEl.mozRequestFullScreen) docEl.mozRequestFullScreen();
    else if (docEl.msRequestFullscreen) docEl.msRequestFullscreen();
  } catch (e) {
    console.log("Fullscreen request blocked or unsupported:", e);
  }
}

// Auto music "silent unlock" hack
function startBackgroundMusic() {
  const bg = document.getElementById("bgmusic");
  if (!bg) return;

  bg.volume = 0;
  const playPromise = bg.play();
  if (playPromise !== undefined) {
    playPromise.then(() => {
      // After short delay, fade to full volume
      setTimeout(() => {
        bg.volume = 1;
      }, 800);
    }).catch((err) => {
      console.log("Autoplay might be blocked in this browser:", err);
    });
  }
}

// Load images into DOM
function loadImages() {
  const slideshow = document.getElementById("slideshow");
  photos.forEach(src => {
    let img = document.createElement("img");
    img.src = src;
    slideshow.appendChild(img);
  });
  imgs = document.querySelectorAll("#slideshow img");
}

// Start slideshow with Ken Burns + shuffle
function startSlideshow() {
  if (slideshowStarted) return;
  slideshowStarted = true;

  // Hide loading text
  const loadingText = document.getElementById("loadingText");
  if (loadingText) loadingText.style.display = "none";

  if (!imgs || imgs.length === 0) {
    console.log("No images yet, retrying slideshow start...");
    setTimeout(startSlideshow, 500);
    return;
  }

  function showSlide() {
    // Clear all
    imgs.forEach(img => {
      img.style.opacity = 0;
      img.classList.remove("kenburns-in", "kenburns-out");
    });

    const current = imgs[index];
    if (current) {
      current.style.opacity = 1;

      // Randomly choose zoom-in or zoom-out (mixed)
      const zoomIn = Math.random() < 0.5;
      if (zoomIn) {
        current.classList.add("kenburns-in");
      } else {
        current.classList.add("kenburns-out");
      }
    }

    index = (index + 1) % imgs.length;
  }

  showSlide(); // first image
  setInterval(showSlide, SLIDE_DURATION);
}

// Fetch photo list from Google Apps Script
function loadFromAPI_JSONP() {
  const cbName = "cb_" + Date.now();

  window[cbName] = function(data) {
    // cleanup
    delete window[cbName];

    if (!data || !data.photos || !data.photos.length) {
      document.getElementById("loadingText").textContent = "No photos found in folder.";
      return;
    }

    photos = shuffleArray(data.photos.slice());
    loadImages();

    setTimeout(startSlideshow, 500);

    // music + fullscreen
    startBackgroundMusic();
    setTimeout(requestFullscreenSafe, 1000);
  };

  const s = document.createElement("script");
  s.src = API_URL + "?callback=" + cbName;
  s.onerror = function() {
    document.getElementById("loadingText").textContent = "API Error loading JSONP.";
  };

  document.body.appendChild(s);
}

// ✅ call JSONP load
loadFromAPI_JSONP();


// As extra safety, attempt fullscreen + music once on load as well
window.addEventListener("load", () => {
  setTimeout(() => {
    startBackgroundMusic();
    requestFullscreenSafe();
  }, 800);
});
</script>

</body>
</html>
